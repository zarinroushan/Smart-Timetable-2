{% extends "base.html" %}
{% block content %}
<div class="content-box">
    <h2 class="mb-4"><i class="fas fa-user-shield"></i> Admin Dashboard</h2>

    <ul class="nav nav-tabs" id="adminTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#core-data" type="button" role="tab"><i class="fas fa-cogs"></i> Core Data & Setup</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="timetable-tab" data-bs-toggle="tab" data-bs-target="#timetable" type="button" role="tab"><i class="fas fa-edit"></i> Manual Timetable Editor</button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-3 p-md-4" id="adminTabContent">
        <div class="tab-pane fade show active" id="core-data" role="tabpanel">
            <div class="row g-4">
                <div class="col-md-4">
                    <h5><i class="fas fa-door-open text-muted"></i> Add Room</h5>
                    <form action="{{ url_for('add_room') }}" method="POST">
                        <input type="text" name="name" class="form-control mb-2" placeholder="Room Name (e.g., 101)" required>
                        <input type="number" name="capacity" class="form-control mb-2" placeholder="Capacity" required>
                        <button type="submit" class="btn btn-primary">Add Room</button>
                    </form>
                </div>
                <div class="col-md-4">
                    <h5><i class="fas fa-users text-muted"></i> Add Student Group</h5>
                    <form action="{{ url_for('add_group') }}" method="POST">
                        <input type="text" name="name" class="form-control mb-2" placeholder="Group Name (e.g., CSE-A)" required>
                        <button type="submit" class="btn btn-primary">Add Group</button>
                    </form>
                    <a href="{{ url_for('manage_users') }}" class="btn btn-secondary mt-3"><i class="fas fa-user-edit"></i> Manage User Roles</a>
                </div>
                 <div class="col-md-4">
                    <h5><i class="fas fa-book text-muted"></i> Add Subject</h5>
                    <form action="{{ url_for('add_subject') }}" method="POST">
                        <input type="text" name="name" class="form-control mb-2" placeholder="Subject Name" required>
                        <input type="text" name="code" class="form-control mb-2" placeholder="Subject Code" required>
                        <select name="lecture_type" class="form-select mb-2"><option value="Lecture">Lecture</option><option value="Lab">Lab</option></select>
                        <input type="number" name="duration" class="form-control mb-2" value="1" min="1" placeholder="Duration (slots)">
                        <label class="form-label small">Assign Teacher(s) (Hold Ctrl/Cmd)</label>
                        <select name="teacher_ids" class="form-select mb-2" required multiple style="height: 100px;">
                            {% for teacher in teachers %}<option value="{{ teacher.id }}">{{ teacher.email }}</option>{% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">Add Subject</button>
                    </form>
                </div>
            </div>
            <hr class="my-4">
            <div class="row g-4">
                <div class="col-md-6">
                    <h5><i class="fas fa-link text-muted"></i> Assign Subjects to Group</h5>
                    <form action="{{ url_for('assign_course') }}" method="POST">
                        <select name="group_id" class="form-select mb-2" required>
                            <option value="">-- Select Group --</option>
                            {% for group in groups %}<option value="{{ group.id }}">{{ group.name }}</option>{% endfor %}
                        </select>
                        <div class="border p-2 rounded" style="height: 150px; overflow-y: auto;">
                            {% for subject in subjects %}<div class="form-check"><input class="form-check-input" type="checkbox" name="subject_ids" value="{{ subject.id }}" id="sub{{ subject.id }}"><label class="form-check-label" for="sub{{ subject.id }}">{{ subject.name }} ({{ subject.code }})</label></div>{% endfor %}
                        </div>
                        <button type="submit" class="btn btn-primary mt-2">Save Assignments</button>
                    </form>
                </div>
                <div class="col-md-6">
                     <h5><i class="fas fa-ban text-muted"></i> Add Blocked Slot (SWC/Events)</h5>
                    <form action="{{ url_for('add_blocked_slot') }}" method="POST">
                        <select name="day" class="form-select mb-2" required><option value="">-- Day --</option>{% for day in days %}<option value="{{ day }}">{{ day }}</option>{% endfor %}</select>
                        <select name="time_slot" class="form-select mb-2" required><option value="">-- Time Slot --</option>{% for slot in time_slots %}<option value="{{ slot }}">{{ slot }}</option>{% endfor %}</select>
                        <select name="group_id" class="form-select mb-2" required><option value="">-- Group --</option>{% for group in groups %}<option value="{{ group.id }}">{{ group.name }}</option>{% endfor %}</select>
                        <input type="text" name="reason" class="form-control mb-2" placeholder="Reason (e.g., SWC)">
                        <button type="submit" class="btn btn-warning">Block Slot</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="timetable" role="tabpanel">
            <h5><i class="fas fa-calendar-alt text-muted"></i> Manual Timetable Editor</h5>
            <a href="{{ url_for('generate_timetable') }}" class="btn btn-info mb-3">Run Auto-Generator (Placeholder)</a>
            <hr>
            <form method="GET" action="{{ url_for('admin_dashboard') }}">
                <input type="hidden" name="tab" value="timetable">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label for="day_select" class="form-label">Select Day to Edit:</label>
                        <select name="selected_day" id="day_select" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Choose a Day --</option>
                            {% for day in days %}<option value="{{ day }}" {% if day == selected_day %}selected{% endif %}>{{ day }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
            </form>
            
            {% if selected_day %}
            <form action="{{ url_for('update_day_timetable') }}" method="POST" class="mt-3">
                <input type="hidden" name="day" value="{{ selected_day }}">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Time Slot</th>
                                {% for group in groups %}<th>{{ group.name }}</th>{% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in time_slots %}
                            <tr>
                                <td><strong>{{ slot }}</strong></td>
                                {% for group in groups %}
                                <td>
                                    {% set current_entry = timetable_data[selected_day][slot][group.id] %}
                                    <select name="subject_{{ slot }}_{{ group.id }}" class="form-select form-select-sm mb-1">
                                        <option value="">-- Subject --</option>
                                        {% for sub in subjects %}<option value="{{ sub.id }}" {% if current_entry and current_entry.subject_id == sub.id %}selected{% endif %}>{{ sub.code }}</option>{% endfor %}
                                    </select>
                                    <select name="teacher_{{ slot }}_{{ group.id }}" class="form-select form-select-sm mb-1">
                                        <option value="">-- Teacher --</option>
                                        {% for t in teachers %}<option value="{{ t.id }}" {% if current_entry and current_entry.teacher_id == t.id %}selected{% endif %}>{{ t.email.split('@')[0] }}</option>{% endfor %}
                                    </select>
                                    <select name="room_{{ slot }}_{{ group.id }}" class="form-select form-select-sm">
                                        <option value="">-- Room --</option>
                                        {% for r in rooms %}<option value="{{ r.id }}" {% if current_entry and current_entry.room_id == r.id %}selected{% endif %}>{{ r.name }}</option>{% endfor %}
                                    </select>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save"></i> Save Changes for {{ selected_day }}</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}